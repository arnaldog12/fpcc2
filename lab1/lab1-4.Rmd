---
title: "Lab 1 - Checkpoint 4 - Minhas perguntas sobre deputados"
author: "Arnaldo Gualberto"
date: "04/04/2017"
output: 
  html_document:
    smart: no
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

No checkpoint 4 do lab1, vou tentar responder as seguintes perguntas:

__1. Para o ano de 2015 (ano de eleições), quanto cada partido gasta ao longo dos meses do ano? Será que o valor aumenta à medida que as eleições se aproximam?__

__2. Qual a correlação entre a cota por estado e o valor líquido? Ou seja, será que estados que tem maior cota necessariamente gastam mais?__

# 0. Includes

```{r}
library(dplyr, warn.conflicts = F)
library(ggplot2)
library(readr)
library(stringr)
library(knitr)

# Coloca todos os titulos dos gráficos centralizados
theme_update(plot.title = element_text(hjust=0.5))

# vetor para os meses do ano
meses <- c("Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro")

# paleta de cores
colorPalette <- c("#000000", "#9D9D9D", "#FFFFFF", "#BE2633", "#E06F8B", "#493C2B", "#A46422", "#EB8931", "#F7E26B", "#2F484E", "#44891A", "#A3CE27", "#1B2632", "#005784", "#31A2F2", "#B2DCEF")
```

# 1. Leitura e limpeza dos dados

Primeiramente, vou carregar os dados e ter uma visão rápida deles:
```{r, message=FALSE, warning=TRUE}
dados <- read_csv("dados/2015-2016-ate-mes-7.csv")
glimpse(dados)
```

Uma explicação mais detalhada sobre cada coluna, pode ser encontrada [aqui](http://www2.camara.leg.br/transparencia/cota-para-exercicio-da-atividade-parlamentar/explicacoes-sobre-o-formato-dos-arquivos-xml).

Vou selecionar, então, somente as colunas que me interessam e remover as linhas com _NA_:
```{r}
dados <- dados %>%
  select(partido = sgPartido, 
         nome = txNomeParlamentar, 
         estado = sgUF, 
         descricao = txtDescricao, 
         valor_liq = vlrLiquido, 
         mes = numMes,
         ano = numAno) %>%
  filter(complete.cases(.))
head(dados, 10)
```

Agora, quero analisar os valores únicos de algumas das colunas que selecionei:
```{r}
"Partidos:";unique(dados$partido);
"Descrições:";unique(dados$descricao);
```

Podemos ver que, ao todo, temos 29 partidos e 18 tipos de despesas diferentes. A partir dos dados que vi até aqui, vou efetuar as seguintes transformações nos dados:

1. Converter os nomes dos deputados e as descrições de despesas para *CamelCase*;
2. Converter as despesas *Emissão de Bilhete Aéreo* para *PASSAGENS AÉREAS*, já que representam a mesma coisa.
3. Remover os valores líquidos negativos - que representam reembolso - para não atrapalhar nos cálculos sobre os valores.

```{r}
dados <- dados %>%
  mutate(descricao = ifelse(descricao == "Emissão Bilhete Aéreo", "PASSAGENS AÉREAS", descricao)) %>%
  mutate(nome = str_to_title(nome)) %>%
  mutate(descricao = str_to_title(descricao)) %>%
  filter(valor_liq > 0)
```

# 2. Respostas
#### a. Para o ano de 2015 (ano de eleições), quanto cada partido gasta ao longo dos meses do ano?

Primeiramente, tenho de filtrar os dados somente de 2015.
```{r}
dados_2015 = dados %>%
  filter(ano == 2015)

glimpse(dados_2015)
```

Além disso, vou restringir minhas análises aos 10 partidos que mais gastaram ao longo do ano, pois quero facilitar a visualização dos gráficos.
```{r}
# Sumariza os gastos totais dos 10 partidos que mais gastam
dados_sum_top_10 = dados_2015 %>%
  group_by(partido) %>% 
  summarise(total = sum(valor_liq)) %>%
  top_n(10, total)

# Pega os dados somentes dos 10 partidos que mais gastam
dados_2015 <- dados_2015 %>%
  filter(partido %in% dados_sum_top_10$partido)
```

Antes de responder a pergunta, quero analisar o valor total gasto pelos 10 partidos que mais gastaram no ano de 2015:
```{r}
dados_sum_top_10 %>% 
  ggplot(aes(x=reorder(partido, total), y = total, fill=partido)) +
  geom_bar(stat="identity") +
  geom_hline(yintercept = mean(dados_sum_top_10$total))
```

Pelo gráfico acima, pode-ser perceber que __o PMDB foi o partido que mais gastou em 2015, seguido pelo PT, PP e PSDB.__ Esses 4 partidos, aliás, gastam mais que a média dos 10 partidos que mais gastam (aproximadamente 17 milhões de reais).

Quero agora observar a distribuição dos valores gastos por cada um desses partidos, além de ter uma noção geral desses valores:
```{r}
dados_2015 %>%
  group_by(partido) %>%
  ggplot(aes(x = partido, y = valor_liq, fill = partido)) +
  geom_boxplot() +
  geom_hline(yintercept = mean(dados_2015$valor_liq)) +
  scale_y_log10()
```

```{r}
summary(dados_2015$valor_liq)
```

```{r}
dados_2015 %>%
  group_by(partido) %>%
  summarise(min = min(valor_liq), mean=mean(valor_liq), median=median(valor_liq), max=max(valor_liq))
```

Pode-se perceber que os partidos apresentam uma distância interquartil e mediana bem similar. Além disso, em praticamente todos os partidos, 75% dos valores encontram-se abaixo da média.

Agora, para responder a pergunta, vou mostrar o gráfico do valor líquido gasto por partido ao longo do ano de 2015:
```{r, fig.width=12}
dados_sum <- dados_2015 %>%
  group_by(partido, mes) %>%
  summarise(total = sum(valor_liq))

dados_sum %>%
  ggplot(aes(x = mes, y = total, fill=partido)) +
  geom_line(aes(colour = partido)) +
  xlim(meses)
```

O gráfico acima também pode ser visualizado de maneira separada para cada partido:
```{r, fig.width=12}
dados_sum <- dados_2015 %>%
  group_by(partido, mes) %>%
  summarise(total = sum(valor_liq))

dados_sum %>%
  ggplot(aes(x = mes, y = total, fill=partido)) +
  geom_line(aes(colour = partido)) +
  facet_grid(partido ~ .) +
  xlim(meses)
```

De uma maneira geral, __os valores gastos por partido tendem a aumentar ao longo do ano__, como esperado. Porém, ao contrário do imaginado, __não há um aumento de gastos significante perto das eleições__ (meses próximos a Outubro). Além disso, o gráfico mostra dois pontos que eu considero importante:

__* Todos os partidos aumentaram os gastos entre os meses Fevereiro-Março e Novembro-Dezembro.__

Como minha pergunta extra a essa questão, quero analisar então os gastos dos meses de Março e Dezembro.

```{r, fig.width=12}
dados_sum <- dados_2015 %>%
  group_by(partido, mes, descricao) %>%
  filter(mes == 3 || mes == 12) %>%
  summarise(total = sum(valor_liq))

dados_sum %>%
  ggplot(aes(x = partido, y = total, fill = descricao)) +
  geom_bar(position = "stack", stat = "identity") +
  facet_wrap(~ mes, labeller = as_labeller(c("3" = "Março", "12" = "Dezembro"))) +
  scale_fill_manual(values = colorPalette)
```

Também podemos, visualizar o gráfico acima de forma proporcional:
```{r, fig.width=12}
dados_sum %>%
  ggplot(aes(x = partido, y = total, fill = descricao)) +
  geom_bar(position = "fill", stat = "identity") +
  facet_wrap(~ mes, labeller = as_labeller(c("3" = "Março", "12" = "Dezembro"))) +
  scale_fill_manual(values = colorPalette)
```

Pelos gráficos acima, pode-se observar que, comparando-se os meses de Março e Dezembro: 

* houve um aumento significativo nas despesas com _Divulgação da Atividade Parlamentar_;
* diminuiram-se as despesas com _Passagens Aéreas_ e, de certa forma, _Locação Ou Fretamento de Veículos Automores_;

A título de curiosidade, quero saber a quantidade de passagens aéreas compradas no mês de Março para todos os partido e quem foi o deputados que mais gastou com _Divulgação da Atividade Parlamentar_:


#### b. Qual a correlação entre a cota por estado e o valor líquido? Ou seja, será que estados que tem maior cota necessariamente gastam mais?

Antes de mais nada, será necessário carregar o arquivo com as informações sobre a cota por estado:
```{r}
dados_cota = read_csv2("dados/valor-cota-por-estado.csv") %>% rename(cota = valor)
glimpse(dados_cota)
```

```{r, fig.width=10}
dados_cota %>%
  ggplot(aes(x=reorder(estado, cota), y=cota, fill=estado)) +
  geom_bar(stat = "identity") +
  geom_hline(yintercept = mean(dados_cota$cota))
```

```{r}
dados_cota %>%
  ggplot(aes(x= 0, y = cota)) +
  geom_boxplot()
```

```{r}
summary(dados_cota$cota)
```

Também será necessário, recarregar os dados de 2015 (para incluir os gastos de todos os partidos):
```{r}
dados_2015 = dados %>%
  filter(ano == 2015)
```

Antes de começar a responder a pergunta, vou criar um dataframe que conterá as principais informações para as respostas, me ajudando a respondê-las:
```{r}
# numero de deputados por estado
dados_dep_por_estado <- dados_2015 %>%
  group_by(estado) %>%
  summarise(n_deputados = length(unique(nome)))

# valor total gasto por estado no ano de 2015
dados_gastos_por_estado <- dados_2015 %>%
  group_by(estado) %>%
  summarise(total_anual_gasto = sum(valor_liq)) 

# valor total ganho e gasto por estado
dados_join <- left_join(dados_dep_por_estado, dados_cota, by = "estado") %>%
  mutate(total_anual_cotas = n_deputados*cota*12) %>%
  left_join(dados_gastos_por_estado, by = "estado")
```


```{r, fig.width=10}
dados_dep_por_estado %>%
  ggplot(aes(x = reorder(estado, n_deputados), y = n_deputados, fill=estado)) +
  geom_bar(stat = "identity")
```

```{r, fig.width=10}
dados_gastos_por_estado %>%
  ggplot(aes(x = reorder(estado, total_anual_gasto), y = total_anual_gasto, fill=estado)) +
  geom_bar(stat = "identity")
```

```{r}
dados_join %>%
  ggplot(aes(x = total_anual_cotas, y = total_anual_gasto)) +
  geom_point(aes(colour=estado))
```

```{r}
cor(dados_join$total_anual_cotas, dados_join$total_anual_gasto, method='pearson')
cor(dados_join$total_anual_cotas, dados_join$total_anual_gasto, method='kendall')
cor(dados_join$total_anual_cotas, dados_join$total_anual_gasto, method='spearman')
```


```{r}
dados_join %>%
  ggplot(aes(x = n_deputados, y = total_anual_gasto)) +
  geom_point(aes(colour = estado))
```

```{r, fig.width=12}
dados_join %>%
  mutate(cota = total_anual_gasto / (n_deputados*12)) %>%
  ggplot(aes(x = reorder(estado, cota), y = cota)) +
  geom_point(aes(colour = "Gasto médio por deputado (mês)")) +
  geom_point(data = dados_cota, aes(colour="Cota por deputado (mês)"))
```

