---
title: "lab1"
author: "Arnaldo Gualberto"
date: "27 de março de 2017"
output: 
  html_document: 
    smart: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

No primeiro documento

Sugiro que você escolha alguns tipos de gastos, e você pode também querer restringir a análise a algum subconjunto de deputados

Perguntas:
a. Em que tipo de despesas os parlamentares gastam mais recursos de sua cota?
b. Que tipos de despesa tem valores que mais variam quando comparamos os deputados? 

E ainda:
- Crie um panorama dos dados mostrando como as variáveis variam isoladamente e em conjunto
- Verifique qual a distribuição dos valores das variáveis, sua centralidade, extremos, concentração e simetria
- Procure e comente caso haja algo supreendente ou estranho nos dados. Caso necessário, lide com esses valores/comportamentos surpreendentes e comente sua decisão

Critérios:
- Há uma resposta correta e bem embasada com dados para Em que tipo de despesas os parlamentares gastam mais?
- Resposta correta e bem embasada para que tipos de despesa tem valores que mais variam
- Há uma análise descritiva das variáveis utilizadas na análise
- Escrita clara e que explica o necessário para entendermos o relatório
- O relatório está em RMarkdown mostrando o código R

## 0. Includes e Settings
```{r}
library(dplyr, warn.conflicts = F)
library(readr)
library(ggplot2)
library(stringr)

# Coloca todos os titulos dos gráficos centralizados
theme_update(plot.title = element_text(hjust=0.5))
```

## 1. Leitura e limpeza dos dados
```{r, message=FALSE, warning=TRUE}
dados <- read_csv("dados/2015-2016-ate-mes-7.csv")
dados <- dados %>% select(sgPartido, txNomeParlamentar, sgUF, txtDescricao, vlrLiquido, ideCadastro) %>% filter(complete.cases(.))
names(dados) <- c("partido", "nome", "uf", "descricao", "valor_liq", "id_deputado")
```

Para essa análise, vou utilizar somente os dados dos deputados da Paraíba. Logo,
```{r}
dados_pb <- dados %>% filter(uf == "PB")
```

Primeiramente, vou analisar os dados na forma bruta em busca de valores estranhos ou duplicados imprimindo os valores únicos para os atributos relevantes nesse caso:
```{r}
"Partidos:";unique(dados_pb$partido);
"Nomes:";unique(dados_pb$nome);
"Descrições:";unique(dados_pb$descricao);
"ID dos Deputados:";unique(dados_pb$id_deputado)
```

Analisando os resultados, vou efetuar as seguintes transformações nos dados:

1. Converter os nomes dos deputados e as descrições de despesas para CamelCase;
2. Converter as despesas "Emissão de Bilhete Aéreo" para "PASSAGENS AÉREAS", já que representam a mesma coisa.
3. Remover os valores liquidos negativos - que representam reembolso - para não atrapalhar nos cálculos sobre os valores.

```{r}
dados_pb <- dados_pb %>%
  mutate(descricao = ifelse(descricao == "Emissão Bilhete Aéreo", "PASSAGENS AÉREAS", descricao)) %>%
  mutate(nome = stringr::str_to_title(nome)) %>%
  mutate(descricao = stringr::str_to_title(descricao)) %>%
  filter(valor_liq > 0)
```

## 2. Visualizações dos dados
Agora que eu realizei as limpezas que queria nos meus dados, vou dar inicio a parte da visualização. Primeiramente, quero saber quantas depesas cada partido tem na tabela:

```{r}
dados_pb %>%
  ggplot(aes(x = partido, fill=partido)) +
  geom_bar() +
  ggtitle("Quantidade de despesas por partido") +
  ylab("Quantidade de Despesas") +
  xlab("Partido") +
  coord_flip()
```

A principio, **o PMDB é o partido que mais gasta na Paraíba**. Porém, temos de verificar primeiro a quantidade de deputados por partido no estado:

```{r}
dados_sum <- dados_pb %>% 
  group_by(partido) %>% 
  summarise(qtde = length(unique(id_deputado)))

dados_sum %>%
  ggplot(aes(x = partido, y = qtde, fill=partido)) +
  geom_bar(stat = "identity") +
  ggtitle("Quantidade de deputados por partido") +
  coord_flip()
  
```

Pode-se ver que **apenas o PMDB e o PSDB são os únicos partidos com mais de um representante**. Então, daqui para frente, vou concentrar minhas análises por deputado, já que em quase todos os casos o valor gasto por um deputado será igual ao do partido.

Agora, quero saber quanto cada Deputado gastou:

```{r}
dados_sum <- dados_pb %>%
  group_by(nome) %>%
  summarise(total = sum(valor_liq)) %>%
  arrange(total)

dados_sum %>%
  ggplot(aes(x = reorder(nome, total), y = total, fill=nome)) +
  geom_bar(stat = 'identity') + 
  geom_hline(yintercept = mean(dados_sum$total)) +
  ggtitle("Valor Liquido Total gasto por deputado") + 
  xlab("Deputado") +
  ylab("Total") +
  coord_flip()
```

Pelo gráfico acima, pode-se ver que **Aguinaldo Ribeiro é o deputado que mais gasta, seguido por Manoel Junior e Rômulo Gouveia**. Além disso, **10 dos 16 deputados gastam mais que a média (R$ 472.415,20)**. **Major Fábio e Ruy Carneiro são os deputados que menos gastam**.

Vamos analisar o maior gasto dos deputados que mais e menos gastam, respectivamente:

```{r}
dados_pb %>% 
  filter(nome == "Aguinaldo Ribeiro") %>% 
  filter(valor_liq == max(valor_liq))
```

```{r}
dados_pb %>% 
  filter(nome == "Major Fábio") %>% 
  filter(valor_liq == max(valor_liq))
```

Pelos dados acima, podemos ver que **o deputado Rômulo Gouveia chegou a gastar R$ 54.000,00 com "Divulgação da Atividade Parlamentar"**, enquanto **o deputado Major Fábio chegou a pagar R$ 2.740,98 com "Passagens Aéreas"**.

Agora eu fiquei curioso: **Qual foi o maior gasto dentre todos os deputados? De quem foi esse gasto?**

```{r}
dados_pb %>%
  filter(valor_liq == max(valor_liq))
```

E a resposta é: **Benjamin Maranhão, que gastou R$ 64.000,00 com ""Divulgação da Atividade Parlamentar** (que desperdício!). Se compararmos com os dados do último gráfico, podemos perceber que **só esse gasto representa mais de 10% de todo o dinheiro que ele gastou**.

## 3. Respostas as questões

Agora que eu fiz as análises preliminares, vou responder as questões do exercício:

### a. Em que tipo de despesas os parlamentares gastam mais recursos de sua cota?
Para responder essa pergunta, vou simplesmente agrupar os dados por tipo de despesa e sumarizar os dados pela soma do valor líquido total.

```{r}
dados_sum <- dados_pb %>%
  group_by(descricao) %>%
  summarise(total = sum(valor_liq)) %>%
  arrange(total)

dados_sum %>%
  ggplot(aes(x = reorder(descricao, total), y = total)) +
  geom_bar(stat = "identity") +
  xlab("Descrição do gasto") +
  ylab("Valor Líquido Total") +
  ggtitle("Valor líquido total gasto por tipo de despesa") +
  coord_flip()
```

É fácil perceber pelo gráfico que **a ""Divulgação da atividade parlamentar" é o tipo de despesa que os deputados mais gastam recursos da cota**, seguido por "Passagens Aéreas", que é praticamente metade desse valor.

Fiquei curioso para saber como seria esse gráfico por deputado.

```{r, fig.width=12}
dados_sum <- dados_pb %>%
  group_by(nome, descricao) %>%
  summarise(total = sum(valor_liq)) %>%
  arrange(total)

dados_sum %>%
  ggplot(aes(x = reorder(nome, total), y = total, fill=descricao)) +
  geom_bar(stat = "identity") +
  ggtitle("Valor liquido por tipo de despesa para cada deputado") +
  xlab("Deputado") +
  ylab("Valor liquido total") +
  coord_flip()
```

Apesar de não ser possível ver o gráfico para todos os deputados claramente, ainda assim é possível ver que o gasto com "Divulgação da Atividade Parlamentar" é a despesa mais presente na maioria dos deputados.

Para tornar fácil a visualização para todos os deputados, vou plotar o gráfico acima com as proporções de cada tipo de despesa para cada deputado:

```{r, fig.width=12}
dados_sum <- dados_pb %>%
  group_by(nome, descricao) %>%
  summarise(total = sum(valor_liq))

dados_sum %>%
  ggplot(aes(x = reorder(nome, total), y = total, fill=descricao)) +
  geom_bar(stat = "identity", position = "fill") +
  ggtitle("Tipo de despesa por deputado") +
  xlab("Deputado") +
  ylab("Proporção por tipo de despesa") +
  coord_flip()
```

Agora é possível observar que apenas os deputados Luiz Couto, Ruy Carneiro, Nilda Gondim e Major Fábio gastam mais recursos proporcionalmente com outros tipos de despesas que em relação a "Divulgação da Atividade Parlamentar".

O gráfico abaixo plota todas as despesas dos deputados distribuidas pelos valores e separadas por tipo.

```{r, fig.width=12}
dados_sum <- dados_pb %>%
  group_by(nome, descricao)

dados_sum %>%
  ggplot(aes(x=nome, y=valor_liq, colour=descricao)) +
  #geom_point(alpha=0.5) +
  geom_point(alpha=0.5, position = position_jitter(width = 0.3)) +
  coord_flip()
```

É possível ver, pelo gráfico acima, que as passagens aéreas são o tipo mais comum de gastos de praticamente todos os deputados. Além disso, podemos ver também que alguns poucos deputados tem gasto maiores que R$20.000,00. Fiquei curioso para saber quais são esses gastos:

```{r}
filter(dados_pb, valor_liq >= 20000)
```

A tabela acima mostra que, como já vimos anteriormente, grandes quantias de dinheiro são gastas com "Divulgação da Atividade Parlamentar". Porém, há dois dados interessantes: **O deputado Ruy Carneiro gastou R$25.200,00 com "Consultorias, Pesquisas e Trabalhos Técnicos"** (que trabalho foi esse? [pesquisar nas notas fiscais]); **O deputado Hugo Mota fretou/alugou uma Aeronave por R$24.150,00!!** Isso dava para comprar pelo menos 10 passagens de ida-volta de última hora! (considerando cada passagem +R$2.000,00).

Outra forma de visualizar o gráfico acima, seria gerar um hetmap mostrando a quantidade de registros por tipo de despesa para cada deputado:

```{r, fig.width=12}
dados_sum <- dados_pb %>%
  group_by(nome, descricao) %>%
  summarise(count = n())

dados_sum %>%
  ggplot(aes(x = nome, y = descricao, fill=count)) +
  geom_tile(colour = "white", size=0.1) +
  geom_text(aes(label = count)) +
  #scale_fill_gradient(low = "white", high = "steelblue", na.value = "white") +
  scale_fill_continuous(na.value = "white", low="white", high="steelblue") +
  theme(panel.background = element_rect(fill = "white", colour = "white")) +
  theme(axis.text.x = element_text(angle = 90)) +
  xlab("Deputado") +
  ylab("Tipo de Despesa") +
  ggtitle("Quantidade de despesas por tipo e deputado")
  #coord_equal()
```

Analisando o gráfico acima, pode-se observar novamente que **"Passagens Aéreas" são os gastos mais comuns dos deputados, seguido por "Combustíveis e Lubrificantes" e "Serviços Postais"**. **O deputado Wellington Roberto é o deputado que mais comprou passagens aéreas (472)**. **Aguinaldo Ribeiro, por sua vez, teve 448 despesas com "Combustíveis e Lubrificantes" (448), quase o dobro do segundo deputado nessa mesma categoria (Benjamin Maranhão com 270 despesas)**. Também é possível ver que **"Assinatura de Publicações" e "Serviço de Segurança Prestado por Empresas Especializadas" são os tipos de despesas menos utilizados pelos deputados.

### b. Que tipos de despesa tem valores que mais variam quando comparamos os deputados? 
Vamos agora analisar os tipos de despesa que tem valores que mais variam ao comparar os deputados.

Para responder essa pergunta, vou utilizar um gráfico do tipo *error bar* mostrando a variação de entre os valores mínimo e máximo para cada tipo de despesa:

```{r, fig.width=12}
dados_sum <- dados_pb %>%
  group_by(descricao) %>%
  summarise(max = max(valor_liq), min = min(valor_liq)) %>%
  arrange(max-min)
  
dados_sum %>%
  ggplot(aes(x = reorder(descricao, max-min))) +
  geom_errorbar(aes(ymax = max, ymin = min))+
  ggtitle("Variação do valor líquido por tipo de despesa") +
  xlab("Tipo de Despesa") +
  ylab("Valor Líquido") +
  coord_flip()
```

Logo, pelo gráfico acima, a resposta é: **A "Divulgação da Atividade Parlamentar" é o tipo de despesa que mais varia entre todos os deputados (entre 0 e R$64.000,00, como visto onde imprimi o maior gasto entre todos os deputados), seguido por "Consultorias, Pesquisas e Trabalhos Técnicos" e "Locação ou Fretamento de Aeronaves"**.

```{r, fig.height=10}
# dados_sum <- dados_pb %>%
#   group_by(nome, descricao) %>%
#   summarise(max = max(valor_liq), min = min(valor_liq)) %>%
#   arrange(max-min)
#
# dados_sum %>%
#   ggplot(aes(x = reorder(descricao, max-min))) + 
#   geom_errorbar(aes(ymax = max, ymin = min)) +
#   theme(axis.text.x = element_text(angle = 90))+
#   facet_grid(nome ~ .)
#ggsave(file="grafico.png", limitsize = FALSE)

dados_sum <- dados_pb %>%
  group_by(nome, descricao) %>%
  summarise(variacao = (max(valor_liq) - min(valor_liq)))

dados_sum %>%
  ggplot(aes(x = nome, y = descricao)) +
  geom_point(aes(size = variacao, colour = variacao)) +
  scale_colour_gradient(low = "orange", high = "red") +
  theme(axis.text.x = element_text(angle = 90))
```

