---
title: "Lab 3 - Checkpoint 3"
author: "Arnaldo Gualberto"
date: "9 de maio de 2017"
output:
  html_document:
    smart: no
---

O objetivo do checkpoint 3 do Lab 3 é realizar novamente a clusterização de algum conjunto de dados, porém desta vez o foco é a visualização dos dados através de técnicas de redução de dimensionalidade.

Para esse checkpoint, foram utilizados dados quantitativos que a CAPES utiliza na avaliação dos programas de pós-graduação em Ciência da Computação segundo o Comitê de Avaliação. Os dados foram coletados da Plataforma Sucupira, e incluem quantificações da produção de artigos, dissertações e teses nos últimos 4 anos para os diferentes PPGs.


Escolha bem as suas variáveis, transformações, normalização, etc., e faça um descritivo das variáveis antes de começar. Também lembre de comentar os grupos encontrados e, principalmente para essa parte do problema, as relações entre as dimensões que você encontrou via PCA e as variáveis originais. Sempre comente também os padrões interessantes que você encontrar.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# 0. Imports and Settings
```{r, message=FALSE}
library(broom)
library(cluster)
library(dplyr, warn.conflicts = FALSE)
library(GGally, warn.conflicts = FALSE)
library(ggdendro)
library(ggplot2)
library(ggfortify)
library(highcharter, quietly = TRUE)
library(knitr)
library(readr)
library(tibble)
library(tidyr)
require(Rtsne, quietly = TRUE)
source('multiplot.R')
```

# 1. Análise Descritiva

Primeiramente, vou carregar os dados e ter uma noção do seus valores:

```{r, message=FALSE}
dados_all <- read_csv("data/capes-cacc.csv")
glimpse(dados_all)
```

A primeira modificação que vou efetuar nos dados é setar os valores nulos para 0. Além disso, vou criar duas novas colunas:

* **periodicos_restrito**: contém a soma dos periódicos publicados em eventos com o Qualis restrito da CAPES (A1, A2 e B1).
* **periodicos_qualis**: contém a soma dos periódicos publicados em eventos com os demais Qualis considerados pela CAPES (B2, B3, B4 e B5).

Logo, além dessas duas variáveis, para essa análise, também considerarei outras seis variáveis:

* **nível**: nível da pós-graduação da instituição definido pela CAPES (de 3 a 7);
* **colaboradores**: média da quantidade de docentes colaboradores por ano ao longo do período considerado pela CAPES para avaliação;
* **permanentes**: média da quantidade de docentes permanentes da instituição por ano ao longo do mesmo período;
* **artigos_conf**: quantidade de artigos publicados em Conferências;
* **dissertacoes**: quantidade de dissertações de Mestrado;
* **teses**: quantidade de teses de Doutorado;

Para fins de visualização, também vou armazenar o nome da instituição.

```{r}
dados <- dados_all %>%
  replace(is.na(.), 0) %>%
  mutate(instituicao = sprintf("%s (%s)", Instituição, Sigla)) %>%
  mutate(periodicos_restrito = periodicos_A1 + periodicos_A2 + periodicos_B1) %>%
  mutate(periodicos_qualis = periodicos_B1 + periodicos_B2 + periodicos_B3 + periodicos_B4 + periodicos_B5) %>%
  select(instituicao,
         nivel = Nível,
         colaboradores = `Docentes colaboradores`,
         permanentes = `Docentes permanentes`,
         artigos_conf = `Artigos em conf`,
         dissertacoes = Dissertacoes,
         teses = Teses,
         periodicos_restrito,
         periodicos_qualis)

dados %>% head()
```

Vamos começar analisando o sumário dos dados:

```{r}
dados %>%
  select(-instituicao) %>%
  summary()
```

O sumário dos dados apresentam informações interessantes: 

- __Há uma instituição que publicou quase 1000 artigos em conferências__ (vamos saber qual é mais a frente); 
- Em média, __14 Doutores são formados no período de avaliação da CAPES__, aproximadamente. 
- __Mais artigos são publicados em periódicos com Qualis restrito do que nos demais Qualis__, tanto na média quanto no total;

Também é importante saber o desvio-padrão dessas variáveis:

```{r}
dados %>%
  summarise(sd(colaboradores), sd(permanentes), sd(artigos_conf), sd(dissertacoes), sd(teses), sd(periodicos_qualis), sd(periodicos_restrito))
```

Podemos ver que _artigos em conferência_ apresentam o maior desvio-padrão, seguido por _periódicos no Qualis restrito_ e _dissertações_, respectivamente.

Vamos agora analisar a distribuição das variáveis individualmente e aos pares:

```{r, fig.width=12, fig.height=6}
dados %>%
  select(-instituicao) %>%
  ggpairs()
```

Ao analisar as variáveis de forma individual (diagonal principal), podemos ver que __praticamente todas as variáveis apresentam uma distribuição à esquerda com cauda longa à direita__. É importante destacar que a variável _nível_ apresenta uma distribuição bimodal, devido ao fato de existirem mais programas de pós-graduação com níveis mais baixos (3 e 4). 

Por outro lado, quando analisamos as variáveis aos pares, podemos ver que existem bastante correlações fortes (> 0.7) entre as variáveis. __A maior correlação é observada entre a quantidade de periódicos publicados no Qualis restrito e nos demais Qualis (0.925), ou seja, quanto mais se publica periódicos em eventos com Qualis restrito, mais se publica nos demais Qualis__. Obviamente, isso não representa uma causalidade, mas, de certa forma, é um comportamento esperado. __Também pode-se observar forte correlação entre a quantidade artigos publicados em periódicos com Qualis restrito e a docentes permanentes (0.901) e artigos publicados em conferências (0.904)__.

Agora, quero fazer algumas visualizações. Primeiramente, quero analisar a distribuição dos níveis dos programas de pós-graduação do país:

```{r, fig.align="center"}
dados %>%
  ggplot(aes(x = nivel)) +
  geom_bar()
```

Como visto anteriormente, __a maior parte dos programas de pós-graduação apresentam os níveis 3 e 4__. Há apenas 5 programas com nível 5. __É interessante observar que há mais programas de nível 7 do que 6 (5 contra 3, respectivamente)__.

Vamos analisar quais são as instituições que mais produzem dissertações de Mestrado:

```{r, fig.align="center"}
dados %>%
  top_n(10, dissertacoes) %>%
  ggplot(aes(x = reorder(instituicao, dissertacoes), y = dissertacoes)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

__A UFPE é a universidade brasileira que mais produz dissertações de Mestrado no país (+400), produzindo mais que o dobro da segunda colocada, a USP (São Carlos)__.

E qual será a universidade que mais produz teses de Doutorado?

```{r, fig.align="center"}
dados %>%
  top_n(10, teses) %>%
  ggplot(aes(x = reorder(instituicao, teses), y = teses)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Nesse caso, ocorre o inverso, com a USP (São Carlos) à frente da UFPE. Porém, a quantidade de teses produzidas é bem mais parecida entre as duas universidades.

Qual a universidade que mais publica artigos em conferência?

```{r, fig.align="center"}
dados %>%
  top_n(10, artigos_conf) %>%
  ggplot(aes(x = reorder(instituicao, artigos_conf), y = artigos_conf)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

De forma individual, a USP de São Carlos é a universidade responsável pelo maior número de publicações em  conferências. Porém, a UFPE aparece com um número maior devido quando somados os dois programas de pós-graduação (_stricto sensu_ e profisional).

Quero agora saber a respeito das publicações em periódicos. Primeiramente, quero analisar as publicações dos periódicos fora do Qualis restrito (B2 a B5):

```{r, fig.align="center"}
dados %>%
  top_n(10, periodicos_qualis) %>%
  ggplot(aes(x = reorder(instituicao, periodicos_qualis), y = periodicos_qualis)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Novamente, a USP (São Carlos) lidera o ranking, com aproximadamente o dobro da segunda colocada, a UniCamp. A UFRJ publica aproximadamente 200 artigos quando considerados os dois programas da pós-graduação (_Informática_ e _Engenharia de Sistemas e Computação_).

Por fim, quero fazer a mesma análise, porém para os artigos publicados em periódicos no Qualis restrito:

```{r, fig.align="center"}
dados %>%
  top_n(10, periodicos_restrito) %>%
  ggplot(aes(x = reorder(instituicao, periodicos_restrito), y = periodicos_restrito)) +
  geom_bar(stat = "identity") +
  coord_flip()
```

Mais uma vez, a USP de São Carlos encabeça o ranking, seguido pela UFPE se considerarmos os dois programas de pós-graduação descritos anteriormente.

É válido destacar que, de maneira geral, algumas das universidades mostradas nos gráficos acima aparecem em praticamente todos os gráficos. Talvez isso indique algum grupo que vamos encontrar no agrupamento que iremos realizar.

Para finalizar a análise descritiva, quero analisar a disposição das variáveis de forma individual: 

```{r, fig.width=12}
plot_nivel <- dados %>%
  ggplot(aes(x = 0, y = nivel)) +
  geom_point(alpha = 0.3) 

plot_colaboradores <- dados %>%
  ggplot(aes(x = 0, y = colaboradores)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_permanentes <- dados %>%
  ggplot(aes(x = 0, y = permanentes)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_artigos_conf <- dados %>%
  ggplot(aes(x = 0, y = artigos_conf)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_dissertacoes <- dados %>%
  ggplot(aes(x = 0, y = dissertacoes)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_teses <- dados %>%
  ggplot(aes(x = 0, y = teses)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_per_qualis <- dados %>%
  ggplot(aes(x = 0, y = periodicos_qualis)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

plot_per_restrito <- dados %>%
  ggplot(aes(x = 0, y = periodicos_restrito)) +
  geom_boxplot() +
  geom_point(alpha = 0.5, position = position_jitter(width = 0.01)) 

multiplot(plot_nivel, plot_colaboradores, plot_permanentes, plot_artigos_conf, plot_dissertacoes, plot_teses, plot_per_qualis, plot_per_restrito, cols = 4)
```

Pelo gráfico acima, conseguimos confirmar que as variáveis se concentram na parte inferior do gráfico, como visto no gráfico de pares. Eu também arriscaria dizer que existem de 3 a 5 grupos de universidades. Vamos verificar isso na próxima seção.

# 2. Clusterização

Antes de efetuarmos a clusterização, vou efetuar a __padronização__ dos dados. Como visto no checkpoint anterior, isso é de extrema imoportância para evitar que variáveis com range grande se sobreponham sobre as variáveis de baixo range de valores.

```{r}
dados_pro <- dados %>%
  mutate(colaboradores = as.vector(scale(colaboradores)),
         permanentes = as.vector(scale(permanentes)),
         artigos_conf = as.vector(scale(artigos_conf+1)),
         dissertacoes = as.vector(scale(dissertacoes+1)),
         teses = as.vector(scale(teses+1)),
         periodicos_qualis = as.vector(scale(periodicos_qualis+1)),
         periodicos_restrito = as.vector(scale(periodicos_restrito+1)))

dados_pro %>% head()
```

## 2.1 Clusterização Hierárquica

O primeiro agrupamento que vou efetuar é a __clusterização hierárquica__. Previamente, eu realizei alguns testes empíricos com combinações diferentes de métodos de distância e agrupamento. Os melhores parâmetros que eu encontrei são mostrados no código a seguir:

```{r, fig.width=12, fig.height=10, message=FALSE}
distancias <- dados_pro %>%
  column_to_rownames("instituicao") %>%
  dist(method = "maximum")

clust_hier <- distancias %>%
  hclust(method = "ward.D")

ggdendrogram(clust_hier, rotate = TRUE)
```

O dendograma acima mostra a árvore de agrupamento realizada pelo algoritmo de clusterização hierárquica. Visualmente, eu acredito que 3 ou 4 grupos formariam uma boa clusterização. Além disso, também quero destacar alguns pontos interessantes:

* **As melhores universidades brasileiras se encontram na parte de baixo do dendograma**;
* **A UFPB foi agrupada com a USP/EACH e FESP/UPE**;
* **A UFCG foi agrupada com a UFPR**;

Vamos agora plotar o gráfico de silhueta. Eu testei o gráfico para 3 e 4 grupos. Acabei escolhendo 4 grupos, pois achei a quantidade de pontos em cada grupo mais homogênea em relação a somente 3 grupos.

```{r, fig.width=12}
plot(silhouette(cutree(clust_hier, k = 4), distancias))
```

Pode-se perceber pelo gráfico acima que os 4 grupos possuem entre 8 e 28 universidades. Ademais, a maior parte dos pontos estão bem alocados em seus grupos. O grupo 3 é o grupo com o melhor alocamento de pontos, enquanto o grupo 2 apresenta a maior dúvida sobre a alocação de alguns de seus pontos.

Tendo em vista que clusterizamos as universidades em 4 grupos pelo algoritmo de clusterização hierárquica, vamos agora analisar as características de cada um dos grupos e distingui-los:

```{r, fig.width=12}
atribuicoes <- cbind(dados_pro, grupo = cutree(clust_hier, k = 4))

atribuicoes %>%
  select(-instituicao) %>%
  ggparcoord(columns = c(1:8), groupColumn="grupo", scale = "globalminmax") +
  facet_grid(paste("Grupo ", grupo) ~ .) +
  theme(legend.position = "none") +
  scale_y_continuous(breaks=c(0, 2, 4, 6))
```

De acordo com o gráfico acima, eu nomearia os grupos da seguinte maneira (fazendo analogia ao campeonato brasileiro):

__Grupo 1__: _Série B_ (Universidades que brigam para subir)
Universidades de nível 3-5, poucos colaboradores e o restante das variáveis na média geral;

__Grupo 2__: _Série C_ (Universidades que querem se tornar "profissionais")
Universidades de nível 3-4, com mais colaboradores que as do _Grupo 1_, porém almejam o Doutorado (Série B) em sua maioria.

__Grupo 3__: _Série D_ (Várzea)
Universidades de nível 3, sem Doutorado, e com a maioria das variáveis abaixo da média.

__Grupo 4__: _Série A_ (Universidades supra-sumo)
Universidades de nível 6-7, com alto nível de produção científica em geral.

Vamos agora visualizar alguns integrantes desses grupos:

```{r}
dados_hclust <- atribuicoes %>%
  left_join(dados, by = c("instituicao")) %>%
  select(instituicao, nivel.y, colaboradores.y, permanentes.y, artigos_conf.y, dissertacoes.y, teses.y, periodicos_qualis.y, periodicos_restrito.y,  grupo)

dados_hclust %>%
  filter(grupo == 1) %>%
  head(10)
```

```{r}
dados_hclust %>%
  filter(grupo == 2) %>%
  head(10)
```

```{r}
dados_hclust %>%
  filter(grupo == 3) %>%
  head(10)
```

```{r}
dados_hclust %>%
  filter(grupo == 4) %>%
  head(10)
```

É interessante notar que a UFPB e UFCG estão situadas no Grupo 2.

## 2.2 K-Means

```{r, fig.align="center"}
set.seed(1234)
explorando_k <- tibble(k = 2:12) %>%
  group_by(k) %>%
  do(
    kmeans(select(dados_pro, -instituicao), centers = .$k, nstart = 20) %>% glance()
  )

explorando_k %>%
  ggplot(aes(x = k, y = tot.withinss)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks=c(2:12))
```

```{r, fig.align="center"}
explorando_k %>%
  ggplot(aes(x = k, y = betweenss/totss)) +
  geom_line() +
  geom_point() +
  scale_x_continuous(breaks = c(2:12))
```


```{r, fig.width=12}
km <- dados_pro %>%
  select(-instituicao) %>%
  kmeans(centers = 4, nstart = 20)

km %>%
  augment(dados_pro) %>%
  select(-instituicao) %>%
  ggparcoord(columns = c(1:8), groupColumn = ".cluster", scale = "globalminmax") +
  facet_grid(paste("Grupo ", .cluster) ~ .) +
  ylab("Z-score") +
  theme(legend.position = "none")
```

# 3. Redução da Dimensionalidade
## 3.1 Principal Component Analysis (PCA)

```{r}
dados_pca <- dados_pro %>%
  select(-instituicao) %>%
  prcomp(scale = FALSE)

as.data.frame(dados_pca$rotation)
```

```{r, fig.align="center"}
tidy(dados_pca, "pcs") %>%
  ggplot(aes(x = PC, y = cumulative, label = cumulative)) +
  geom_line() +
  geom_point() +
  geom_text(vjust = 1, hjust = -.1)
```

```{r, fig.width=12}
dados_pro_aug <- km %>% augment(dados)

dados_pca %>%
  augment(dados_pro_aug) %>%
  ggplot(aes(x = .fittedPC1, y = .fittedPC2, color = .cluster)) +
  geom_point(alpha = 0.8) +
  theme(legend.position = "none")
```

```{r, fig.width=12}
p = dados_pca %>%
  augment(dados_pro_aug) %>%
  hchart("scatter", hcaes(x = .fittedPC1, y = .fittedPC2, color = .cluster)) %>%
  hc_tooltip(pointFormat = "<b>{point.instituicao}</b><br>
                     Nível: {point.nivel}<br>
             Colaboradores: {point.colaboradores}<br>
               Permanentes: {point.permanentes}<br>
             Artigos Conf.: {point.artigos_conf}<br>
              Dissertações: {point.dissertacoes}<br>
                     Teses: {point.teses}<br>
                Per. A1-B1: {point.periodicos_restrito}<br>
                Per. B2-B5: {point.periodicos_qualis}")
p
```

```{r, fig.width=12}
autoplot(dados_pca, label = F, label.size = 3, shape = T, colour = km$cluster, loadings = TRUE, loadings.color = 'red', loadings.label = TRUE, loadings.label.size = 3, loadings.label.hjust=1.1)
```

## 3.2 t-SNE

```{r, fig.width=12}
set.seed(1234)
tsne.out = dados_pro %>%
  select(-instituicao) %>%
  Rtsne(perplexity = 20)

df <- as.data.frame(tsne.out$Y)
dados_tsne <- cbind(dados_pro_aug, df)

dados_tsne %>%
  ggplot(aes(x = V1, y = V2, color = .cluster)) +
  geom_point(alpha = 0.8) +
  theme(legend.position = "none")
```


```{r}
p <- dados_tsne %>%
  hchart("scatter", hcaes(x = V1, y = V2, color = .cluster)) %>%
  hc_tooltip(pointFormat = "<b>{point.instituicao}</b><br>
                     Nível: {point.nivel}<br>
             Colaboradores: {point.colaboradores}<br>
               Permanentes: {point.permanentes}<br>
             Artigos Conf.: {point.artigos_conf}<br>
              Dissertações: {point.dissertacoes}<br>
                     Teses: {point.teses}<br>
                Per. A1-B1: {point.periodicos_restrito}<br>
                Per. B2-B5: {point.periodicos_qualis}")

p
```
